#!/bin/bash

# üëâ –°–ø—Ä–∞–≤–∫–∞
usage() {
    echo -e "\nüß∞ USAGE: $0 [--dry-run] [--help]"
    
    echo -e "\nüîç –û–ø–∏—Å–∞–Ω–∏–µ:"
    echo "  –°–∫—Ä–∏–ø—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ –≤—Å–µ–º –ø–æ–¥–∫–∞—Ç–∞–ª–æ–≥–∞–º —Ç–µ–∫—É—â–µ–≥–æ –¥–µ—Ä–µ–≤–∞ –∏ –∏—â–µ—Ç Git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏."
    echo "  –î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:"
    echo "    ‚Ä¢ –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—É—Ç—å –∏ –∏–º—è"
    echo "    ‚Ä¢ –ü–µ—Ä–µ–±–∏—Ä–∞–µ—Ç –≤—Å–µ remotes"
    echo "    ‚Ä¢ –î–ª—è –∫–∞–∂–¥–æ–≥–æ remote –≤—ã–ø–æ–ª–Ω—è–µ—Ç 'git tree readd <remote>'"
    echo "      (—É–¥–∞–ª—è–µ—Ç –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç –≤–Ω–µ—à–Ω–∏–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π)"
    echo "  –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–∂–¥–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥."
    
    echo -e "\nüìå –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:"
    echo "  --dry-run   ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ, –Ω–æ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–æ–º–∞–Ω–¥—ã"
    echo "  --help      ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ"
    
    echo -e "\nüìã –ü—Ä–∏–º–µ—Ä—ã:"
    echo "  $0"
    echo "  $0 --dry-run"
}

# üëâ –†–∞–∑–±–æ—Ä –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
DRY_RUN=false
while [[ $# -gt 0 ]]; do
    case "$1" in
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --help)
            usage
            exit 0
            ;;
        *)
            echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä: $1"
            usage
            exit 1
            ;;
    esac
done

# üëâ –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
CDIR=$(pwd)
echo -e "\n===== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ remotes –≤–æ –≤—Å–µ—Ö –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö ====="

for i in $(find . -type d -name ".git"); do
    cd "$i/.." || continue
    NAME=$(pwd)
    BNAME=$(basename "$NAME")

    echo -e "\nüìÇ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: $NAME"
    echo "üîç –ò–º—è: $BNAME"

    for j in $(git remote); do
        if $DRY_RUN; then
            echo "  üß™ [dry-run] –ü–µ—Ä–µ—Å–æ–∑–¥–∞–ª –±—ã remote: $j"
        else
            echo "  üîÑ –ü–µ—Ä–µ—Å–æ–∑–¥–∞—é remote: $j"
            git tree readd "$j"
        fi
    done

    cd "$CDIR" || exit 1
done

echo -e "\n‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ"
