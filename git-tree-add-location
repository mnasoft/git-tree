#!/bin/bash

CONFIG="$HOME/.git-tree/locations.conf"

print_usage() {
  echo "üß© –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
  echo "  git-tree-add-location <id> [--name=custom_name] [--url=custom_git_url]"
  exit 1
}

# üí¨ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è ID
[[ -z "$1" ]] && print_usage

id="$1"
shift

# ‚ú® –ü–∞—Ä—Å–∏–Ω–≥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
while [[ $# -gt 0 ]]; do
  case "$1" in
    --name=*)   custom_name="${1#--name=}" ;;
    --url=*)    custom_url="${1#--url=}" ;;
    *)          echo "‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä: $1" && print_usage ;;
  esac
  shift
done

# –ï—Å–ª–∏ –∏–º—è –Ω–µ –∑–∞–¥–∞–Ω–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º id
custom_name="${custom_name:-$id}"

# üîÅ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –ª–æ–∫–∞—Ü–∏–π
[[ -f "$CONFIG" ]] && source "$CONFIG"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
for loc in "${LOCATIONS[@]}"; do
  [[ "$loc" == "$id" ]] && {
    echo "‚ö†Ô∏è –õ–æ–∫–∞—Ü–∏—è '$id' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    exit 1
  }
done

echo "‚úÖ –î–æ–±–∞–≤–ª—è—é –ª–æ–∫–∞—Ü–∏—é: $id (–∏–º—è: $custom_name)"

# üöÄ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
{
  echo ""
  echo "# –î–æ–±–∞–≤–ª–µ–Ω–æ: $(date '+%Y-%m-%d %H:%M:%S')"
  echo "LOCATIONS+=('$id')"
  [[ "$custom_name" != "$id" ]] && echo "NAME_${id}='${custom_name}'"
  [[ -n "$custom_url" ]] && echo "CUSTOM_URL_GIT[$id]=\"${custom_url}\""
} >> "$CONFIG"

echo "üíæ –û–±–Ω–æ–≤–ª–µ–Ω–æ: $CONFIG"
