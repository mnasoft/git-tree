#!/bin/bash

# üìò USAGE: ./scan_git_repos.sh [-all | <–∫–æ–ª-–≤–æ_–¥–Ω–µ–π>] [-bare <–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è>] [-compress] [--dry-run]

# üëâ –°–ø—Ä–∞–≤–∫–∞
if [[ $# -eq 0 || "$1" == "--help" ]]; then
    echo -e "\nüß∞ USAGE: $0 [-all | <–∫–æ–ª-–≤–æ_–¥–Ω–µ–π>] [-bare <–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è>] [-compress] [--dry-run]"
    echo -e "\nüîç –û–ø–∏—Å–∞–Ω–∏–µ:"
    echo "  –°–∫–∞–Ω–∏—Ä—É–µ—Ç –≤—Å–µ –ø–æ–¥–∫–∞—Ç–∞–ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ Git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤"
    echo "  –∏ –≤—ã–≤–æ–¥–∏—Ç –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–º–º–∏—Ç–∞ –≤ –∫–∞–∂–¥–æ–º –∏–∑ –Ω–∏—Ö."
    echo "  –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ -bare —Å–æ–∑–¥–∞—ë—Ç bare-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏."
    echo "  –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ -compress –∞—Ä—Ö–∏–≤–∏—Ä—É–µ—Ç –∫–∞–∂–¥—ã–π bare-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ .tar.xz"
    echo "  –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ --dry-run –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ, –Ω–æ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è."
    echo -e "\nüìå –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:"
    echo "  -all            ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç DAYS=99999)"
    echo "  <–∫–æ–ª-–≤–æ_–¥–Ω–µ–π>   ‚Äî —á–∏—Å–ª–æ –¥–Ω–µ–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –¥–∞—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–º–º–∏—Ç–∞"
    echo "  -bare <dir>     ‚Äî –ø—É—Ç—å –∫ –∫–∞—Ç–∞–ª–æ–≥—É, –∫—É–¥–∞ –±—É–¥—É—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã bare-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏"
    echo "  -compress       ‚Äî –≤–∫–ª—é—á–∞–µ—Ç —Å–∂–∞—Ç–∏–µ –∫–∞–∂–¥–æ–≥–æ bare-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ –∞—Ä—Ö–∏–≤"
    echo "  --dry-run       ‚Äî —Å–∏–º—É–ª–∏—Ä—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è –±–µ–∑ –∏—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è"
    echo -e "\nüìã –ü—Ä–∏–º–µ—Ä—ã:"
    echo "  $0 -all"
    echo "  $0 30 -bare /mnt/usb/git-sync -compress --dry-run"
    echo ""
    exit 0
fi

# üß© –†–∞–∑–±–æ—Ä –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
DAYS=""
BARE_DIR=""
COMPRESS=false
DRY_RUN=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        -all)
            DAYS=99999
            shift
            ;;
        -bare)
            BARE_DIR="$2"
            shift 2
            ;;
        -compress)
            COMPRESS=true
            shift
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        *)
            DAYS="$1"
            shift
            ;;
    esac
done

# –ü—Ä–æ–≤–µ—Ä–∫–∞ DAYS
if [[ -z "$DAYS" ]]; then
    echo "‚ùå –ù–µ —É–∫–∞–∑–∞–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π. –ò—Å–ø–æ–ª—å–∑—É–π -all –∏–ª–∏ —á–∏—Å–ª–æ."
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ bare-–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [[ -n "$BARE_DIR" ]]; then
    if ! $DRY_RUN; then
        mkdir -p "$BARE_DIR" || { echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥ $BARE_DIR"; exit 1; }
    fi
fi

tempfile=$(mktemp)
logfile="sync.log"
now=$(date +%s)

echo -e "\nüìã –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º –∫–æ–º–º–∏—Ç–æ–º –Ω–µ —Å—Ç–∞—Ä—à–µ $DAYS –¥–Ω–µ–π:\n" | tee "$logfile"

find . -type d -name ".git" | while read gitdir; do
    repo_dir=$(dirname "$gitdir")
    cd "$repo_dir" || continue

    last_commit_date=$(git log -1 --format="%ci" 2>/dev/null)

    if [ -n "$last_commit_date" ]; then
        commit_ts=$(date -d "$last_commit_date" +%s)
        age_days=$(( (now - commit_ts) / 86400 ))

        if [ "$age_days" -le "$DAYS" ]; then
            echo "$last_commit_date|$repo_dir" >> "$tempfile"
        fi
    fi

    cd - > /dev/null
done

sort "$tempfile" | while IFS="|" read date path; do
    echo "üïí $date ‚Üí üìÅ $path" | tee -a "$logfile"

    if [[ -n "$BARE_DIR" ]]; then
        repo_name=$(basename "$path")
        target="$BARE_DIR/$repo_name.git"
        archive="$BARE_DIR/$repo_name.git.tar.xz"

        if $DRY_RUN; then
            echo "üß™ [dry-run] –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω bare-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: $target" | tee -a "$logfile"
            if $COMPRESS; then
                echo "üß™ [dry-run] –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –∞—Ä—Ö–∏–≤: $archive" | tee -a "$logfile"
            fi
        else
            echo "üì¶ –°–æ–∑–¥–∞—é bare-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: $target" | tee -a "$logfile"
            git clone --bare "$path" "$target" 2>/dev/null

            if $COMPRESS; then
                echo "üóúÔ∏è –ê—Ä—Ö–∏–≤–∏—Ä—É—é: $archive" | tee -a "$logfile"
                tar -cJf "$archive" -C "$BARE_DIR" "$repo_name.git"
                rm -rf "$target"
            fi
        fi
    fi
done

rm "$tempfile"
echo -e "\n‚úÖ –ì–æ—Ç–æ–≤–æ. –õ–æ–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤: $logfile"
