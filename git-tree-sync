#!/bin/bash

# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./scan_git_repos.sh [ะบะพะป-ะฒะพ_ะดะฝะตะน]
# ะัะธะผะตั: ./scan_git_repos.sh 30

# ะะพะปััะธัั ะบะพะปะธัะตััะฒะพ ะดะฝะตะน ะธะท ะฐัะณัะผะตะฝัะฐ (ะฟะพ ัะผะพะปัะฐะฝะธั 9999)
DAYS=${1:-9999}

# ะัะตะผะตะฝะฝัะน ัะฐะนะป
tempfile=$(mktemp)

# ะขะตะบััะฐั ะดะฐัะฐ ะฒ ัะตะบัะฝะดะฐั
now=$(date +%s)

# ะะฐะนัะธ ะฒัะต .git ะบะฐัะฐะปะพะณะธ
find . -type d -name ".git" | while read gitdir; do
    repo_dir=$(dirname "$gitdir")
    cd "$repo_dir" || continue

    # ะะพะปััะธัั ะดะฐัั ะฟะพัะปะตะดะฝะตะณะพ ะบะพะผะผะธัะฐ
    last_commit_date=$(git log -1 --format="%ci" 2>/dev/null)

    if [ -n "$last_commit_date" ]; then
        # ะัะตะพะฑัะฐะทะพะฒะฐัั ะดะฐัั ะฒ ัะตะบัะฝะดั
        commit_ts=$(date -d "$last_commit_date" +%s)
        age_days=$(( (now - commit_ts) / 86400 ))

        # ะคะธะปัััะฐัะธั ะฟะพ ะฒะพะทัะฐััั
        if [ "$age_days" -le "$DAYS" ]; then
            echo "$last_commit_date|$repo_dir" >> "$tempfile"
        fi
    fi

    cd - > /dev/null
done

# ะัะฒะพะด ะพััะพััะธัะพะฒะฐะฝะฝะพะณะพ ัะฟะธัะบะฐ
echo -e "\n๐ ะะตะฟะพะทะธัะพัะธะธ ั ะฟะพัะปะตะดะฝะธะผ ะบะพะผะผะธัะพะผ ะฝะต ััะฐััะต $DAYS ะดะฝะตะน:\n"
sort "$tempfile" | while IFS="|" read date path; do
    echo "๐ $date โ ๐ $path"
done

rm "$tempfile"
